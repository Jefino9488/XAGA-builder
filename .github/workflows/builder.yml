name: Fastboot Builder

on:
  workflow_dispatch:
    inputs:
      URL:
        description: official recovery
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: maximizeYourBuildEnvironment
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 8192
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'

      - name: CheckOutWarehouseFiles
        uses: actions/checkout@main

      - name: Set Git user info
        run: |
          git config user.email "ajefinojacob9488@gmail.com"
          git config user.name "Jefino9488"
        shell: bash

      - name: prepareTheRequiredEnvironment
        run: |
          echo "device=xaga" >> $GITHUB_ENV
          echo "version=$(echo ${{ github.event.inputs.URL }} | cut -d"/" -f4)" >> $GITHUB_ENV
          sudo apt-get install python3 aria2 p7zip-full zstd

      - name: Build ROM
        run: |
          sudo bash "$GITHUB_WORKSPACE"/build.sh ${{ github.event.inputs.URL }} $GITHUB_WORKSPACE

      - name: Configure Git LFS
        run: |
          git lfs install
          git lfs track "$GITHUB_WORKSPACE/zip/${{ env.device }}_fastboot.zip"
          git add .gitattributes
          git commit -m "Enable Git LFS for large files"
          git push origin main

      - name: Upload Release
        run: |
          mkdir -p "$GITHUB_WORKSPACE/GithubRelease"
          cp "$GITHUB_WORKSPACE/zip/${{ env.device }}_fastboot.zip" "$GITHUB_WORKSPACE/GithubRelease/"

          git lfs fetch origin main
          git lfs push origin main

          cd "$GITHUB_WORKSPACE/GithubRelease"
          ls -lh  # Print file sizes for verification

      - name: Create and Upload Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "$GITHUB_WORKSPACE/GithubRelease/${{ env.device }}_fastboot.zip"
          name: "${{ env.version }}"
          tag: "${{ env.version }}"
          allowUpdates: true
          artifactErrorsFailBuild: true
          token: ${{ secrets.GITHUB_TOKEN }}
